#!/usr/bin/make -f
#export DH_VERBOSE=1

# [ Maintainer Notes ]
#
# Unlike the nvidia-cuda-toolkit packaging, I wouldn't like to maintain a
# bunch of *.install files. Here all the *.install files are auto-generated
# from python script debian/control.py .
#
# Apart from that, I'd strongly suggest you build this package under /dev/shm!

# These variables are used as memo.
MKL_ORIG_TARBALL = l_mkl_2018.2.199.tgz
MD5SUM           = fd31b656a8eb859c89495b9cc41230b4
SHA256SUM = e28d12173bef9e615b0ded2f95f59a42b3e9ad0afa713a79f8801da2bfb31936

# for debugging i386 builds on amd64
#export DEB_HOST_ARCH = i386
#export DEB_HOST_MULTIARCH = i386-linux-gnu


%:
	dh $@

extract-upstream-rpms:
	set -e; for rpmfile in $$(find rpm -type f -name '*.rpm'); do \
		rpm2cpio $$rpmfile | cpio -idmv; \
		done

override_dh_auto_configure: extract-upstream-rpms
	python3 debian/control.py  # Generate install files
	sed -e "s/@DEB_HOST_MULTIARCH@/$(DEB_HOST_MULTIARCH)/g" \
		< debian/libmkl-rt.postinst.in > debian/libmkl-rt.postinst
	chmod +x debian/libmkl-rt.postinst
	sed -e "s/@DEB_HOST_MULTIARCH@/$(DEB_HOST_MULTIARCH)/g" \
		< debian/libmkl-rt.prerm.in > debian/libmkl-rt.prerm
	chmod +x debian/libmkl-rt.prerm

override_dh_auto_clean:
	-$(RM) debian/*.install  # auto-generated install files
	-$(RM) debian/*.lintian-overrides  # auto-generated lintian files
	-$(RM) debian/*.postinst debian/*.prerm  # auto-gen maintainer scripts
	-$(RM) -rf opt  # extracted from upstream rpm packages

# don't strip any of these binary blobs as agreed in intel's license.
override_dh_strip:
override_dh_strip_nondeterminism:
	true
