#!/usr/bin/make -f
#export DH_VERBOSE=1

# [ Maintainer Notes ]
# Unlike the nvidia-cuda-toolkit packaging, I wouldn't like to maintain a
# bunch of *.install files. Here all the *.install files are auto-generated
# from rules.

MKL_ORIG_TARBALL = l_mkl_2018.2.199.tgz
MKL_INCS = \
	opt/intel/compilers_and_libraries_2018.2.199/linux/mkl/include
MKL_LIBS_amd64 = \
	opt/intel/compilers_and_libraries_2018.2.199/linux/mkl/lib/intel64_lin

INST_INCS = usr/include/mkl/
INST_LIBS_amd64 = usr/lib/x86_64-linux-gnu/

%:
	dh $@

extract-upstream-rpms:
	set -e; for rpmfile in $$(find rpm -type f -name '*.rpm'); do \
		rpm2cpio $$rpmfile | cpio -idmv; \
		done

override_dh_auto_configure: extract-upstream-rpms
	find $(MKL_INCS) -type f -exec \
		echo '{}' $(INST_INCS) \; >> debian/libmkl-dev.install
	find $(MKL_LIBS_amd64) -type f -name '*.so' -exec \
		echo '{}' $(INST_LIBS_amd64) \; >> debian/libmkl.install
	find $(MKL_LIBS_amd64) -type f -name '*.a' -exec \
		echo '{}' $(INST_LIBS_amd64) \; >> debian/libmkl-dev.install
	dh_auto_configure

override_dh_auto_clean:
	-$(RM) debian/*.install  # auto-generated install files
	-$(RM) -rf opt  # extracted from upstream rpm packages

# don't strip any of these binary blobs as agreed in intel's license.
override_dh_strip:
override_dh_strip_nondeterminism:
	true
